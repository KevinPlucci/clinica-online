<div class="perfil-container">
  <div class="perfil-card" *ngIf="cargando()">
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando perfil...</p>
    </div>
  </div>

  <div class="perfil-card fade-in" *ngIf="!cargando() && me() as usuario">
    <div class="header">
      <div class="avatar-wrapper">
        <img
          [src]="usuario.fotoURL || usuario.fotoURL1 || 'assets/avatar-placeholder.png'"
          alt="Foto de perfil"
          class="avatar"
        />
      </div>
      <div class="info-header">
        <h1>{{ usuario.nombre }} {{ usuario.apellido }}</h1>
        <span class="rol-badge">{{ usuario.rol }}</span>
      </div>
    </div>

    <div class="body">
      <div class="section-title">Datos Personales</div>
      <div class="datos-grid">
        <div class="dato-item">
          <label>Email</label>
          <p>{{ usuario.email }}</p>
        </div>
        <div class="dato-item">
          <label>DNI</label>
          <p>{{ usuario.dni }}</p>
        </div>
        <div class="dato-item">
          <label>Edad</label>
          <p>{{ usuario.edad }} aÃ±os</p>
        </div>
        <div class="dato-item" *ngIf="usuario.obraSocial">
          <label>Obra Social</label>
          <p>{{ usuario.obraSocial }}</p>
        </div>
      </div>

      <!-- SECCIÃ“N DE ESPECIALISTA (Horarios) -->
      <div class="especialista-section" *ngIf="usuario.rol === 'especialista'">
        <div class="section-header">
          <div class="section-title">Mis Horarios</div>
          <button class="btn-edit" *ngIf="!editando()" (click)="editando.set(true)">
            âœŽ Editar
          </button>
        </div>

        <div class="horarios-view" *ngIf="!editando()">
          <div *ngFor="let esp of usuario.especialidades" class="esp-block">
            <h3>{{ esp }}</h3>
            <ul *ngIf="getHorariosArray(esp).length > 0; else sinHorarios">
              <li *ngFor="let h of getHorariosArray(esp)">
                {{ diasSemana[h.dia - 1].nombre }}: {{ h.desde }} - {{ h.hasta }}
              </li>
            </ul>
            <ng-template #sinHorarios>
              <p class="no-data">Sin horarios definidos</p>
            </ng-template>
          </div>
        </div>

        <div class="horarios-edit" *ngIf="editando()">
          <div *ngFor="let esp of usuario.especialidades" class="esp-edit-block">
            <h4>{{ esp }}</h4>
            <div class="horario-row" *ngFor="let h of getHorariosArray(esp); let i = index">
              <select [(ngModel)]="h.dia">
                <option *ngFor="let d of diasSemana" [value]="d.id">
                  {{ d.nombre }}
                </option>
              </select>
              <input type="time" [(ngModel)]="h.desde" />
              <span>a</span>
              <input type="time" [(ngModel)]="h.hasta" />
              <button class="btn-remove" (click)="removeHorario(esp, i)">âœ–</button>
            </div>
            <button class="btn-add" (click)="addHorario(esp)">+ Agregar horario</button>
          </div>

          <div class="actions">
            <button class="btn-save" (click)="guardarHorarios()" [disabled]="cargando()">
              Guardar Cambios
            </button>
            <button class="btn-cancel" (click)="cancelarEdicion()">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- SECCIÃ“N DE PACIENTE (Historia ClÃ­nica y Reportes) -->
      <div class="paciente-section" *ngIf="usuario.rol === 'paciente'">
        <div class="section-title">Mi Historia ClÃ­nica</div>
        <div class="hc-actions">
          <!-- BotÃ³n original -->
          <button
            class="btn-download"
            (click)="descargarHistoriaClinica()"
            [disabled]="descargandoPdf()"
          >
            {{ descargandoPdf() ? 'Generando PDF...' : 'ðŸ“„ Descargar Completa' }}
          </button>

          <app-historia-clinica [pacienteId]="usuario.uid"></app-historia-clinica>
        </div>

        <!-- +++ NUEVA SECCIÃ“N: DESCARGA POR PROFESIONAL +++ -->
        <div
          class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200"
          style="margin-top: 1.5rem; padding: 1.5rem; background: #f8fafc; border-radius: 8px"
        >
          <h3 style="font-size: 1.1rem; color: #1e3a8a; margin-bottom: 1rem">
            Descargar por Profesional
          </h3>

          <div
            *ngIf="especialistasVisitados().length > 0; else noVisitas"
            style="display: flex; gap: 10px; align-items: center"
          >
            <select
              [ngModel]="especialistaSeleccionado()"
              (ngModelChange)="especialistaSeleccionado.set($event)"
              style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; flex: 1"
            >
              <option value="" disabled selected>Seleccione un profesional</option>
              <option *ngFor="let esp of especialistasVisitados()" [value]="esp">{{ esp }}</option>
            </select>

            <button
              class="btn-save"
              [disabled]="!especialistaSeleccionado() || descargandoPdf()"
              (click)="descargarAtencionesPorProfesional()"
              style="white-space: nowrap"
            >
              Descargar PDF
            </button>
          </div>
          <ng-template #noVisitas>
            <p style="color: #666; font-style: italic">
              AÃºn no tienes atenciones finalizadas para filtrar.
            </p>
          </ng-template>
        </div>
      </div>
    </div>

    <div class="footer">
      <a routerLink="/bienvenida" class="link-home">Volver al inicio</a>
    </div>

    <div class="alert" *ngIf="mensaje()">
      {{ mensaje() }}
    </div>
  </div>
</div>
