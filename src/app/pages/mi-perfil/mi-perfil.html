<div class="perfil-container" *ngIf="me() as user; else loading">
  <div class="perfil-card">
    <header class="perfil-header">
      <h1>Mi Perfil</h1>
      <a routerLink="/bienvenida" class="btn btn-secondary">← Volver</a>
    </header>

    <section class="perfil-info">
      <div class="perfil-avatar">
        <img
          [src]="user.fotoURL || user.fotoURL1 || user.fotoURL2 || 'assets/avatar-placeholder.png'"
          alt="Foto de {{ user.nombre }}"
          class="avatar-img"
        />
      </div>

      <div class="perfil-datos">
        <h2>{{ user.nombre }} {{ user.apellido }}</h2>
        <p class="rol">{{ user.rol | titlecase }}</p>

        <div class="datos-principales">
          <div class="dato" *ngIf="user.email">
            <span class="label">Email</span>
            <span class="valor">{{ user.email }}</span>
          </div>
          <div class="dato" *ngIf="user.dni">
            <span class="label">DNI</span>
            <span class="valor">{{ user.dni }}</span>
          </div>
          <div class="dato" *ngIf="user.edad">
            <span class="label">Edad</span>
            <span class="valor">{{ user.edad }} años</span>
          </div>
          <div class="dato" *ngIf="user.obraSocial">
            <span class="label">Obra Social</span>
            <span class="valor">{{ user.obraSocial }}</span>
          </div>
        </div>

        <div class="especialidades-section" *ngIf="user.rol === 'especialista'">
          <span class="label">Especialidades</span>
          <div class="chip-container">
            <span class="chip" *ngFor="let esp of user.especialidades">{{ esp }}</span>
          </div>
        </div>

        <div class="acciones-paciente" *ngIf="user.rol === 'paciente'">
          <button
            class="btn btn-primary btn-pdf"
            (click)="descargarHistoriaClinica()"
            [disabled]="descargandoPdf()"
          >
            {{ descargandoPdf() ? 'Generando PDF...' : 'Descargar Historia Clínica' }}
          </button>
        </div>
      </div>
    </section>

    <!--
      +++ INICIO: SECCIÓN HISTORIA CLÍNICA (SOLO PACIENTE) +++
    -->
    <section class="perfil-seccion" *ngIf="user.rol === 'paciente'">
      <h3>Mi Historia Clínica</h3>
      <!--
        El contenedor es para darle un padding, ya que el componente
        reutilizable no tiene márgenes exteriores.
      -->
      <div class="historia-clinica-container">
        <app-historia-clinica [pacienteId]="user.uid"></app-historia-clinica>
      </div>
    </section>
    <!-- +++ FIN: SECCIÓN HISTORIA CLÍNICA +++ -->

    <section
      class="perfil-fotos"
      *ngIf="user.rol === 'paciente' && (user.fotoURL1 || user.fotoURL2)"
    >
      <h3>Mis Fotos de Registro</h3>
      <div class="fotos-grid">
        <img *ngIf="user.fotoURL1" [src]="user.fotoURL1" alt="Foto 1" />
        <img *ngIf="user.fotoURL2" [src]="user.fotoURL2" alt="Foto 2" />
      </div>
    </section>

    <section class="perfil-horarios" *ngIf="user.rol === 'especialista'">
      <div class="horarios-header">
        <h3>Mis Horarios de Atención</h3>
        <button *ngIf="!editando()" class="btn btn-primary" (click)="editando.set(true)">
          Editar Horarios
        </button>
      </div>

      <div class="mensaje-guardado" *ngIf="mensaje()">{{ mensaje() }}</div>

      <div class="horarios-list">
        <div *ngFor="let esp of user.especialidades" class="horario-especialidad-group">
          <h4>{{ esp }}</h4>

          <div *ngIf="!editando()" class="vista-horarios">
            <ul *ngIf="getHorariosArray(esp).length > 0; else noHorarios">
              <li *ngFor="let h of getHorariosArray(esp)">
                <span class="dia">{{ diasSemana[h.dia - 1].nombre }}</span>
                <span class="horas">{{ h.desde }} - {{ h.hasta }} hs</span>
              </li>
            </ul>
            <ng-template #noHorarios>
              <p class="no-horarios-msg">Sin horarios configurados.</p>
            </ng-template>
          </div>

          <div *ngIf="editando()" class="editor-horarios">
            <div class="horario-row" *ngFor="let h of getHorariosArray(esp); let i = index">
              <select [(ngModel)]="h.dia" class="form-input">
                <option *ngFor="let dia of diasSemana" [value]="dia.id">{{ dia.nombre }}</option>
              </select>
              <div class="time-inputs">
                <input type="time" [(ngModel)]="h.desde" class="form-input" step="1800" />
                <span>a</span>
                <input type="time" [(ngModel)]="h.hasta" class="form-input" step="1800" />
              </div>
              <button class="btn-remove" (click)="removeHorario(esp, i)" title="Eliminar">
                &times;
              </button>
            </div>
            <button class="btn btn-add" (click)="addHorario(esp)">+ Agregar horario</button>
          </div>
        </div>
      </div>

      <div class="editor-actions" *ngIf="editando()">
        <button class="btn btn-outline" (click)="cancelarEdicion()">Cancelar</button>
        <button class="btn btn-success" (click)="guardarHorarios()" [disabled]="cargando()">
          {{ cargando() ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </section>
  </div>
</div>

<ng-template #loading>
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>
</ng-template>
