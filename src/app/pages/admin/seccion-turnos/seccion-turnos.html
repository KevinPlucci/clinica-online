<div class="turnos-container" *ngIf="me$ | async as me">
  <header class="turnos-header">
    <h1>Turnos de la Clínica</h1>
    <a [routerLink]="getVolverLink()" class="btn btn-secondary">← Volver a Usuarios</a>
  </header>

  <!-- Filtro Único -->
  <div class="filtro-container">
    <input
      type="text"
      class="filtro-input"
      placeholder="Buscar en todos los campos (paciente, espec., fecha, H.C...)"
      [(ngModel)]="filtroInput"
      (input)="actualizarFiltro()"
    />
    <button type="button" class="btn-limpiar" *ngIf="filtroInput" (click)="limpiarFiltro()">
      &times;
    </button>
  </div>

  <!--
    +++ NOTA DE CORRECCIÓN +++
    Se eliminó el segundo argumento (': 'admin') del pipe 'filtroTurnos' en el *ngIf de abajo,
    porque el pipe universal ahora solo acepta un argumento (el texto de búsqueda).
  -->
  <div
    class="turnos-lista"
    *ngIf="turnos$ | async | filtroTurnos : (filtro$ | async) ?? '' as turnos; else loading"
  >
    <!-- Vista de Administrador -->
    <div
      class="turno-card"
      *ngFor="let t of turnos; trackBy: trackByTurnoId"
      [attr.data-estado]="t.estado"
    >
      <!-- El admin ve toda la info -->
      <div class="turno-info">
        <span class="turno-fecha">{{ t.fecha.toDate() | date : 'dd/MM/yyyy HH:mm' }}</span>
        <span class="turno-especialidad">{{ t.especialidad }}</span>
        <span class="turno-actor"><b>Paciente:</b> {{ t.pacienteNombre }}</span>
        <span class="turno-actor"><b>Dr/a:</b> {{ t.especialistaNombre }}</span>
      </div>

      <div class="turno-estado">
        <span class="estado-badge">{{ t.estado | uppercase }}</span>
      </div>
      <div class="turno-acciones">
        <!-- Botón de Admin: Cancelar -->
        <button
          *ngIf="t.estado === 'solicitado' || t.estado === 'aceptado'"
          class="btn btn-warn"
          (click)="abrirModal('cancelar', t)"
        >
          Cancelar
        </button>
        <!--
          NOTA: Si un turno está 'realizado', el admin puede querer ver la H.C.
          Esto se podría añadir aquí copiando el botón de 'mis-turnos.html'
        -->
      </div>
    </div>

    <!-- Mensaje si no hay turnos -->
    <div *ngIf="turnos.length === 0" class="no-turnos">
      <p>No hay turnos que coincidan con la búsqueda.</p>
    </div>
  </div>

  <ng-template #loading>
    <div class="loading-turnos">Cargando turnos...</div>
  </ng-template>
</div>

<!-- Modal Genérico para Comentarios -->
<div class="modal-overlay" *ngIf="modalVisible" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="cerrarModal()">&times;</button>

    <!-- Título dinámico -->
    <h3 *ngIf="modalContexto === 'cancelar'">Cancelar Turno</h3>

    <!-- Textarea -->
    <div class="form-field">
      <label> Motivo/Comentario: </label>
      <textarea rows="5" [(ngModel)]="comentarioModal"></textarea>

      <div class="err" *ngIf="errorModal">{{ errorModal }}</div>
    </div>

    <!-- Botones del Modal -->
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
      <button type="button" class="btn btn-primary" (click)="confirmarModal()">Confirmar</button>
    </div>
  </div>
</div>
